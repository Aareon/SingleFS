<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>SingleFS</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js" integrity="sha512-pumBsjNRGGqkPzKHndZMaAG+bir374sORyzM3uulLV14lN5LyykqNk8eEeUlUkB3U0M4FApyaHraT65ihJhDpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>

    <header>
      <div class="logo">SingleFS</div>

      {% if session.login is none %}
      <button title="You must login to upload!" class="btn upload-button" disabled>Upload</button>
      {% endif %}
      {% if session.login is not none %}
      <button class="btn upload-button" onclick="showUploadDialog()">Upload</button>
      <div class="upload-dialog" id="upload-dialog">
        <span class="upload-dialog-close" onclick="document.getElementById('upload-dialog').style.display='none'">&times;</span>
        <h2>Upload</h2>
        <form method="POST" action="/upload">
          <label for="file">File:</label>
          <input type="file" id="upload-file" name="file">
          <label for="password">Password:</label>
          <input type="password" id="upload-password" name="password">
          <input type="submit" value="Upload">
        </form>
        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
      </div>
      {% endif %}

      {% if session.login is none %}
      <button class="btn login-button" onclick="showLoginDialog()">Login</button>
      <div class="login-dialog" id="login-dialog">
        <span class="login-dialog-close" onclick="document.getElementById('login-dialog').style.display='none'">&times;</span>
        <h2>Login</h2>
        <form method="POST" action="/login" id="login-form">
          <label for="email">Email:</label>
          <input type="email" id="login-email" name="email">
          <label for="password">Password:</label>
          <input type="password" id="login-password" name="password">
          <input type="submit" value="Login" id="login-submit-button">
        </form>
      </div>

      <button class="btn signup-button" onclick="showSignupDialog()">Signup</button>
      <div class="signup-dialog" id="signup-dialog">
        <span class="signup-dialog-close" onclick="document.getElementById('signup-dialog').style.display='none'">&times;</span>
        <h2>Signup</h2>
        <form method="POST" action="/register">
          <label for="email">Email:</label>
          <input type="email" id="signup-email" name="email">
          <label for="username">Username:</label>
          <input type="text" id="signup-username" name="username">
          <label for="password">Password:</label>
          <input type="password" id="signup-password" name="password">
          <label for="password-confirmation">Confirm Password:</label>
          <input type="password" id="signup-password-confirmation" name="password-confirmation">
          <input type="submit" value="Signup" id="signup-submit-button">
        </form>
      </div>
      {% endif %}

      {% if session.login is not none %}
      <p>Logged in as {{ session.username }}</p>
      <button class="btn logout-button" onclick="location.href='/logout'">Logout</button>
      {% endif %}
    </header>

    <div class="news-panel">
      <h2>Site Updates</h2>
      <p>We have recently made some changes to our website. Here are some of the updates:</p>
      <ul>
        <li><a href="https://github.com/Aareon/SingleFS">Source code available on Github</a></li>
        <li><a href="#">About SingleFS & Mission Statement</a></li>
        <li><a href="#">How we keep your files safe</a></li>
        <li><a href="#">How to contact us about illegal content</a></li>
      </ul>
    </div>

    <footer>
      <div class="file-stats">
        <p>Files uploaded: <span id="files-uploaded">0</span></p>
        <p>Total file size: <span id="total-file-size">0</span> KB</p>
      </div>
    </footer>

    <script>
      $(document).ready(function() {
        $("#signup-submit-button").click(function() {
          event.preventDefault();
          
          //get inputs
          var signupEmail = $("#signup-email").val();
          var signupUsername = $("#signup-username").val();
          var signupPassword = $("#signup-password").val();
          var signupPasswordConfirmation = $("#signup-password-confirmation").val();

          if(signupEmail != "" && signupUsername != "" && signupPassword != "" && signupPasswordConfirmation != "" && signupPassword == signupPasswordConfirmation)
          {
            $.post("/register", {email: signupEmail, username: signupUsername, password: signupPassword}, function( data ) {
              alert( data );
            });
          }
          else
          {
            alert('One or more required fields are empty, or your passwords do not match');
          }
        });

        $("#login-submit-button").click(function() {
          event.preventDefault();
          
          //get inputs
          var loginEmail = $("#login-email").val();
          var loginPassword = $("#login-password").val();

          if(loginEmail != "" && loginPassword != "")
          {
            $.post("/login", {email: loginEmail, password: loginPassword}, function( data ) {
                if(data == "Incorrect password" || data == "User does not exist")
                {
                  alert( data );
                }
                else
                {
                  $("#login-form").submit();
                }
            });
          }
          else
          {
            alert('One or more required fields are empty');
          }
        });
      });

      function showLoginDialog() {
        var loginDialog = document.getElementById("login-dialog");
        loginDialog.style.display = "block";
      }

      function showSignupDialog() {
        var signupDialog = document.getElementById("signup-dialog");
        signupDialog.style.display = "block";
      }

      function showUploadDialog() {
        var uploadDialog = document.getElementById("upload-dialog");
        uploadDialog.style.display = "block";
      }

      function uploadFile(event) {
        event.preventDefault(); // Prevent form submission
        
        var xhr = new XMLHttpRequest();
        var progressBar = document.getElementById("progress-bar");
        
        xhr.upload.addEventListener("progress", function(event) {
          if (event.lengthComputable) {
            var percentComplete = event.loaded / event.total * 100;
            progressBar.style.width = percentComplete + "%";
            progressBar.innerHTML = Math.round(percentComplete) + "%";
          }
        }, false);
        
        xhr.open("POST", "/upload-file", true);
        xhr.send(new FormData(event.target));
      }

    </script>

  </body>
</html>
